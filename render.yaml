services:
  - type: web
    name: verified-digital-twin-brain-api
    runtime: python
    plan: standard
    region: oregon
    
    # Build configuration
    buildCommand: |
      echo "=== Starting Build ==="
      pip install --upgrade pip
      pip install --no-cache-dir -r backend/requirements.txt
      echo "=== Build Complete ==="
    
    # Start command with single worker to reduce memory usage
    startCommand: |
      echo "=== Starting Application ==="
      cd backend
      uvicorn main:app --host 0.0.0.0 --port $PORT --workers 1 --timeout-keep-alive 120 --log-level info
    
    # Health check configuration
    healthCheckPath: /health
    healthCheckTimeout: 120
    healthCheckInterval: 15
    
    # Wait longer before starting health checks (grace period)
    # This gives the app time to fully start up
    
    autoDeploy: true
    
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PIP_NO_CACHE_DIR
        value: "true"
      # Required secrets (set in Render dashboard)
      - key: LANGFUSE_PUBLIC_KEY
        sync: false
      - key: LANGFUSE_SECRET_KEY
        sync: false
      - key: LANGFUSE_HOST
        value: https://cloud.langfuse.com
      - key: OPENAI_API_KEY
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: PINECONE_API_KEY
        sync: false
      - key: PINECONE_INDEX_NAME
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: CEREBRAS_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: JWT_SECRET
        sync: false
      # Cohere Reranking (REQUIRED for production)
      - key: COHERE_API_KEY
        sync: false
      - key: COHERE_RERANK_STRICT
        value: "true"
      - key: ENABLE_FLASHRANK
        value: "true"
      - key: COHERE_RERANK_TIMEOUT_SECONDS
        value: "5.0"
      - key: HYBRID_COHERE_WEIGHT
        value: "0.7"
      - key: SELECTIVE_RERANKING_THRESHOLD
        value: "0.75"
      - key: RERANK_CACHE_ENABLED
        value: "true"

    # Ephemeral disk for temp files
    disk:
      name: tmp
      mountPath: /tmp
      sizeGB: 1

  - type: worker
    name: verified-digital-twin-brain-worker
    runtime: python
    plan: standard
    region: oregon

    buildCommand: |
      echo "=== Starting Worker Build ==="
      pip install --upgrade pip
      pip install --no-cache-dir -r backend/requirements.txt
      echo "=== Worker Build Complete ==="

    startCommand: |
      echo "=== Starting Worker ==="
      cd backend
      python worker.py

    autoDeploy: true

    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PIP_NO_CACHE_DIR
        value: "true"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: PINECONE_API_KEY
        sync: false
      - key: PINECONE_INDEX_NAME
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: CEREBRAS_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: REDIS_URL
        sync: false
      # Cohere Reranking (REQUIRED for worker)
      - key: COHERE_API_KEY
        sync: false
      - key: COHERE_RERANK_STRICT
        value: "true"
      - key: ENABLE_FLASHRANK
        value: "true"
