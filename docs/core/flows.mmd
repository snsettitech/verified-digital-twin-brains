# System Flows

## 1. Twin Lifecycle
```mermaid
stateDiagram-v2
    [*] --> PENDING : TwinCreateRequest (POST /twins)
    PENDING --> ONBOARDING : Start Ingestion / Interview
    ONBOARDING --> VERIFICATION_REQUIRED : Ingestion Complete
    VERIFICATION_REQUIRED --> VERIFIED : TwinVerificationRequest (MANUAL_REVIEW)
    VERIFICATION_REQUIRED --> REJECTED : Governance Policy Violation
    VERIFIED --> ACTIVE : Activation Trigger
    ACTIVE --> SUSPENDED : patch /twins (is_active=false)
    SUSPENDED --> ACTIVE : patch /twins (is_active=true)
    REJECTED --> [*]
    ACTIVE --> [*] : Delete Twin
```

## 2. Query & Retrieval Flow
```mermaid
graph TD
    User([User]) --> API[chat.py API]
    API --> Orchestrator[agent.py: run_agent_stream]
    
    subgraph "Reasoning Layer"
        Orchestrator --> Reasoning{Is Reasoning Query?}
        Reasoning -- Yes --> GraphRAG[reasoning_engine.py: predict_stance]
        Reasoning -- No --> RetrievalTier[retrieval.py: retrieve_context]
    end

    subgraph "Retrieval Tiers"
        RetrievalTier --> Tier1[VerifiedQnA Match]
        Tier1 -- Miss --> Tier2[Pinecone Vector Search]
        Tier2 -- Weak --> Tier3[Composio Tool Search]
    end

    subgraph "Response Generation"
        GraphRAG --> Synthesizer[answering.py: generate_answer]
        Tier1 -- Hit --> Synthesizer
        Tier2 -- Hit --> Synthesizer
        Tier3 -- Hit --> Synthesizer
    end

    Synthesizer --> Audit[governance.py: log_interaction]
    Audit --> User
```

## 3. Action & Approval Flow
```mermaid
graph TD
    Intent[Agent Intent / run_agent_stream] --> EventBus[EventEmitter: emit 'message_received']
    EventBus --> Matcher[TriggerMatcher: match_conditions]
    
    subgraph "Governance Gateway"
        Matcher --> Policy[GovernancePolicy: check_active]
        Policy --> Draft[ActionDraftManager: create_draft]
    end

    Draft -- PENDING_APPROVAL --> Owner([Owner Approval])
    Owner -- Approved --> Execution[ExecutionEngine: execute_action]
    
    subgraph "Execution Layer"
        Execution --> Connector[ToolConnector: run_tool]
        Connector --> Result[ActionExecutionSchema: SUCCESS/FAILED]
    end

    Result --> Logging[AuditLog: log_activity]
    Logging --> Finalize[ActionDraft.status: EXECUTED]
```

## 4. Escalation & Learning Flow
```mermaid
graph TD
    Confidence[run_agent_stream: confidence_score < 0.7] --> Router[escalation.py: create_escalation]
    Router --> Queue[EscalationSchema: status='PENDING']
    
    subgraph "Human-in-the-Loop"
        Queue --> Dashboard[Owner Dashboard]
        Dashboard --> Review([Human Review])
        Review --> Respond[DraftRespondRequest: response_message]
    end

    Respond --> Memory[save_as_verified: true]
    Memory --> Update[VerifiedQnASchema: insert]
    
    Respond --> Finalize[EscalationSchema: status='RESPONDED']
    Update --> KnowledgeBase[(Knowledge Base Updated)]
```
