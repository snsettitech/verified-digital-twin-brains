name: Automated Code Review

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read
  checks: write

jobs:
  code-quality:
    name: Code Quality Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: 'backend/.python-version'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'frontend/.nvmrc'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pylint flake8 black isort bandit

      - name: Install Frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Check Python Code Style
        run: |
          cd backend
          black --check . --line-length 100 || true
          isort --check-only . --profile black || true
        continue-on-error: true

      - name: Security Check (Backend)
        run: |
          cd backend
          bandit -r . -ll --skip B101,B601 -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Lint Frontend
        run: |
          cd frontend
          npm run lint -- --format=json --output-file=eslint-report.json || true
        continue-on-error: true

      - name: Type Check Frontend
        run: |
          cd frontend
          npm run typecheck || true
        continue-on-error: true

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          path: '.'
          format: 'JSON'
        continue-on-error: true

  documentation:
    name: Documentation Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for documentation updates
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            
            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            // Check if docs are updated when code changes
            const codeFiles = files.filter(f => 
              f.filename.startsWith('backend/') || 
              f.filename.startsWith('frontend/') ||
              f.filename.startsWith('database/')
            ).filter(f => !f.filename.includes('test'));
            
            const docFiles = files.filter(f => 
              f.filename.startsWith('docs/') || 
              f.filename.endsWith('.md')
            );
            
            if (codeFiles.length > 0 && docFiles.length === 0) {
              console.log('‚ö†Ô∏è Code changes detected but no documentation updates');
              core.warning('Consider updating relevant documentation for code changes');
            }

  architecture-impact:
    name: Architecture Impact Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze architecture changes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            
            // Critical files that require extra scrutiny
            const criticalFiles = [
              'backend/modules/_core/',
              'backend/modules/auth_guard.py',
              'backend/modules/observability.py',
              'backend/modules/clients.py',
              'backend/main.py',
              'frontend/middleware.ts',
              'frontend/lib/supabase/',
              'backend/database/schema/',
            ];
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            const criticalChanges = files.filter(f => 
              criticalFiles.some(cf => f.filename.includes(cf))
            );
            
            if (criticalChanges.length > 0) {
              const comment = `‚ö†Ô∏è **Architecture-Critical Files Modified**\n\nThis PR modifies architecture-critical files:\n${criticalChanges.map(f => `- \`${f.filename}\``).join('\n')}\n\n**Review Checklist:**\n- [ ] Changes maintain multi-tenant isolation\n- [ ] No breaking changes to existing APIs\n- [ ] Authentication/authorization patterns unchanged\n- [ ] All database queries filtered by tenant_id\n- [ ] Backward compatibility maintained or clearly documented`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment,
              });
            }

  test-coverage:
    name: Test Coverage Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: 'backend/.python-version'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Run backend tests with coverage
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov
          pytest --cov=modules --cov=routers --cov-report=term-missing --cov-report=json -v -m "not network" || true
        continue-on-error: true

      - name: Comment coverage results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('backend/.coverage.json', 'utf8'));
              console.log('Coverage report generated');
            } catch (e) {
              console.log('No coverage report available');
            }
        continue-on-error: true

  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            const requiredSections = [
              'What Changed',
              'How to Test',
              'Risk and Rollback',
              'Checklist'
            ];
            
            const missingSection = requiredSections.find(section => 
              !body.includes(`## ${section}`) && !body.includes(`# ${section}`)
            );
            
            if (missingSection) {
              core.setFailed(`Missing required PR section: "${missingSection}"`);
              console.log(`‚ùå PR template not fully completed. Missing: ${missingSection}`);
            } else {
              console.log('‚úÖ PR template properly completed');
            }

      - name: Check for conventional commits
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ ! $COMMIT_MSG =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?!?: ]]; then
            echo "‚ö†Ô∏è Warning: Commit message does not follow conventional commits"
            echo "Expected format: feat|fix|docs|...(...): message"
            exit 0
          fi
        continue-on-error: true

  migration-check:
    name: Database Migration Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for migration files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            // Check if schema changes without migration
            const schemaChanges = files.filter(f => 
              f.filename.includes('database/schema/')
            );
            
            const migrations = files.filter(f => 
              f.filename.includes('database/migrations/')
            );
            
            if (schemaChanges.length > 0 && migrations.length === 0) {
              core.warning('Schema changes detected without corresponding migrations');
            }
            
            // Check migration quality
            migrations.forEach(f => {
              const content = f.patch || '';
              if (!content.includes('CREATE TABLE') && !content.includes('ALTER TABLE')) {
                return;
              }
              
              if (!content.includes('IF NOT EXISTS') && !content.includes('IF EXISTS')) {
                core.warning(`Migration ${f.filename} should include IF EXISTS/IF NOT EXISTS for idempotency`);
              }
              
              if (content.includes('CREATE TABLE') && !content.includes('RLS') && !content.includes('ROW LEVEL SECURITY')) {
                core.warning(`Migration ${f.filename} creates a table but doesn't mention RLS policies`);
              }
            });

  config-validation:
    name: Configuration Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate environment variables
        run: |
          echo "Checking for hardcoded secrets..."
          grep -r "OPENAI_API_KEY\|PINECONE_API_KEY\|JWT_SECRET\|SUPABASE_KEY" \
            backend/ frontend/ --include="*.py" --include="*.ts" --include="*.tsx" \
            | grep -v "os.getenv\|process.env\|.env" || true
          echo "Check complete"
        continue-on-error: true

      - name: Validate Docker configs
        run: |
          if [ -f Dockerfile ]; then
            echo "üê≥ Dockerfile found, performing basic checks..."
            grep -q "EXPOSE\|ENTRYPOINT\|CMD" Dockerfile || echo "‚ö†Ô∏è Consider adding EXPOSE, ENTRYPOINT, or CMD"
          fi
        continue-on-error: true
